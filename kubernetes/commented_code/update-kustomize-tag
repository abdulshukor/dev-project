#!/bin/bash
# Use Bash to run this script.

# Exit immediately if any command exits with a non-zero status (error).
# This prevents the script from continuing when something goes wrong.
set -e

# --------------------------------------------------------------------
# 1. Check arguments
# --------------------------------------------------------------------

# "$#" = number of arguments passed to the script.
# We expect exactly 3:
#   1) input tag (e.g. "v1.2.3")
#   2) kustomization file path (e.g. "manifests/dev/kustomization.yaml")
#   3) image name (e.g. "backend" or "ghcr.io/user/app")
if [ "$#" -ne 3 ]; then
  echo "Usage: $0 <input-tag> <kustomization-file-path> <image-name>" # Print usage message.
  # They mean < > “this is a placeholder for a required argument”.
  # $0 → script name
   #<input-tag> → the tag to set
   #<kustomization-file-path> → YAML file to edit
   #<image-name> → which image to update
   # Example:
   #   ./update-kustomize-tag.sh v1.2.3 manifests/dev/kustomization.yaml backend  
  
  # $0 is the script name itself.
  exit 1 # Exit with error if the wrong number of args is given.
fi

# Positional parameters:
# $1, $2, $3 are the arguments given on the command line.
INPUT_TAG=$1          # The new image tag we want to set.
KUSTOMIZATION_FILE=$2 # Path to kustomization.yaml (or similar).
IMAGE_NAME=$3         # Name of the image to update in that file.

# Print what we received (useful for debugging / clarity).
echo "Script received Input Tag: $INPUT_TAG"
echo "Script received Kustomization File: $KUSTOMIZATION_FILE"
echo "Script received Image Name: $IMAGE_NAME"

# --------------------------------------------------------------------
# 2. Check for yq and kustomization file
# --------------------------------------------------------------------

# Check if yq is installed and available in PATH.
# "command -v yq" returns non-zero if yq is not found.
if ! command -v yq &>/dev/null; then
  echo "Error: yq command could not be found."
  exit 1
fi

# Check that the kustomization file actually exists.
# -f means "is this a regular file?"
if [ ! -f "$KUSTOMIZATION_FILE" ]; then
  echo "Error: Kustomization file not found at '$KUSTOMIZATION_FILE'"
  exit 1
fi

echo "Updating Kustomize image '$IMAGE_NAME' in $KUSTOMIZATION_FILE to tag: $INPUT_TAG"

# --------------------------------------------------------------------
# 3. Detect yq version (Go yq vs Python yq) and update the tag
# --------------------------------------------------------------------

# There are different tools named "yq":
# - mikefarah/yq (popular Go-based yq)
# - Python yq (wrapper around jq)
# Their syntax is slightly different, so we detect which one is installed.

# yq --version prints version info.
# We check if the string "mikefarah" appears in the version output.
if yq --version 2>&1 | grep -q "mikefarah"; then
  # --- Using mikefarah/yq (Go version) ---

  # This command:
  # - Loads the YAML file
  # - Goes into .images[]
  # - For each element, select the one with .name == IMAGE_NAME
  # - Set .newTag to INPUT_TAG for that element
  # - -i edits the file in-place
  yq eval ".images[] |= select(.name == \"$IMAGE_NAME\").newTag = \"$INPUT_TAG\"" -i "$KUSTOMIZATION_FILE"

else
  # --- Likely using Python yq (syntax is a bit different) ---

  # First, escape any slashes (/) and ampersands (&) in IMAGE_NAME,
  # because they could interfere with sed or yq / jq filters.
  ESCAPED_IMAGE_NAME=$(printf '%s\n' "$IMAGE_NAME" | sed 's/[\/&]/\\&/g')

  # Here we:
  # - Use yq (python version) to process the YAML
  # - Update .images[] entries where .name == ESCAPED_IMAGE_NAME
  # - Set .newTag to INPUT_TAG
  # - Output to a temporary file, then move it back over original.
  #   This is needed because Python yq doesn't support in-place edits like -i.
  yq -y ".images[] |= (select(.name == \"$ESCAPED_IMAGE_NAME\") | .newTag = \"$INPUT_TAG\")" \
    "$KUSTOMIZATION_FILE" >"${KUSTOMIZATION_FILE}.tmp" &&
    mv "${KUSTOMIZATION_FILE}.tmp" "$KUSTOMIZATION_FILE"
fi

# --------------------------------------------------------------------
# 4. Show result
# --------------------------------------------------------------------

echo "Successfully updated $KUSTOMIZATION_FILE"

# Print the updated file so the user can see the changes.
echo "--- Updated $KUSTOMIZATION_FILE content ---"
cat "$KUSTOMIZATION_FILE"
echo "--- End of $KUSTOMIZATION_FILE content ---"

# Exit successfully.
exit 0
