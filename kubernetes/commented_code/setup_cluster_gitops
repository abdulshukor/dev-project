#!/bin/bash
# Use the Bash shell to run this script.

# Exit immediately if any command exits with a non-zero (error) status.
# This stops the script when something goes wrong instead of continuing.
set -e

# -------------------------------------------------------------------
# Color codes for nicer terminal output
# -------------------------------------------------------------------
GREEN='\033[0;32m'  # Green text
RED='\033[0;31m'    # Red text
YELLOW='\033[1;33m' # Yellow text
NC='\033[0m'        # No Color (reset)

# -------------------------------------------------------------------
# 1. Check for required environment variables
# -------------------------------------------------------------------

# These environment variables must be set before running:
# - DEVPOD: usually the workspace folder name (e.g. dev-project)
# - DEVPOD_WORKSPACE_ID: the DevPod workspace ID used in the /workspaces path
# "DEVPOD" vs "DEVPOD_WORKSPACE_ID" 
# DEVPOD = name of the folder
# DEVPOD_WORKSPACE_ID = unique identifier for the workspace

required_vars=("DEVPOD" "DEVPOD_WORKSPACE_ID")
missing_vars=() # empty array to collect missing variable names

# Loop through each required variable name
for var in "${required_vars[@]}"; do
  # ${!var} = "indirect expansion": if var="DEVPOD", ${!var} = value of $DEVPOD
  # [ -z STRING ] is true if STRING is empty or unset
  if [ -z "${!var}" ]; then
    # Add the name of the missing variable to the missing_vars array
    missing_vars+=("$var")
  fi
done

# If we have one or more missing vars, complain and exit
if [ ${#missing_vars[@]} -ne 0 ]; then
  echo -e "${RED}Error: The following required environment variables are not set:${NC}"
  # Print each missing variable as a bullet point
  for var in "${missing_vars[@]}"; do
    echo "  - $var"
  done
  echo "Please set these variables before running this script."
  exit 1
fi

# -------------------------------------------------------------------
# 2. Paths, names, and important variables
# -------------------------------------------------------------------

# SCRIPT_DIR = absolute path of the directory where this script lives.
# This allows the script to find files next to it, no matter where you run it from.
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# BASE_DIR = path to the project root under /workspaces
# Example: /workspaces/dev-project
# $DEVPOD_WORKSPACE_ID is the unique ID for the DevPod workspace vs $DEVPOD which is the name of the folder
# Example: /workspaces/<workspace_id>
# This is where the scripts/ folder lives
# When to $DEVPOD alone, it gives just the folder name 
# When to $DEVPOD_WORKSPACE_ID, it gives the unique workspace ID
# Example: /workspaces/<workspace_id>


BASE_DIR="/workspaces/$DEVPOD"

# Name of the k3d cluster to create/use
CLUSTER_NAME="study-app-cluster"

# Directory where the SSH deploy keys are stored
# Example: /workspaces/<workspace_id>/dev-keys
KEY_DIR="/workspaces/$DEVPOD_WORKSPACE_ID/dev-keys"

echo -e "${GREEN}DevOps Study App - Kubernetes GitOps Deployment Helper${NC}"
echo -e "${YELLOW}This script will set up a k3d cluster and configure GitOps for the study app.${NC}"
echo ""

# -------------------------------------------------------------------
# 3. Check for required tools (dependencies)
# -------------------------------------------------------------------

# Define a helper function to check if a command exists
check_dependency() {
  # command -v <name> returns non-zero if the command is not found
  if ! command -v "$1" &>/dev/null; then
    echo -e "${RED}Error: $1 is not installed. Please install it before proceeding.${NC}"
    exit 1
  fi
}

echo "Checking dependencies..."
check_dependency k3d     # for running Kubernetes in Docker
check_dependency kubectl # for talking to the Kubernetes cluster
check_dependency docker  # container runtime used by k3d
check_dependency flux    # GitOps tool
echo -e "${GREEN}All dependencies are installed.${NC}"
echo ""

# -------------------------------------------------------------------
# 4. Create or reuse k3d cluster
# -------------------------------------------------------------------

# Check if a cluster with this name already exists
if k3d cluster list | grep -q "$CLUSTER_NAME"; then
  echo -e "${YELLOW}Cluster $CLUSTER_NAME already exists.${NC}"
  # Ask the user if they want to delete and recreate the cluster
  read -p "Do you want to delete and recreate it? (y/n): " -r
  # [[ $REPLY =~ ^[Yy]$ ]] checks if the answer starts with y or Y
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "Deleting existing cluster..."
    k3d cluster delete "$CLUSTER_NAME"
  else
    echo "Using existing cluster."
  fi
fi

# If the cluster does NOT exist (anymore), create it
if ! k3d cluster list | grep -q "$CLUSTER_NAME"; then
  echo "Creating k3d cluster using config file..."
  # Use the k3d-config.yaml that sits in the same directory as this script
  k3d cluster create --config "$SCRIPT_DIR/k3d-config.yaml"
  echo -e "${GREEN}Cluster created successfully!${NC}"
fi

# -------------------------------------------------------------------
# 5. Configure kubectl to talk to the new cluster
# -------------------------------------------------------------------

echo "Configuring kubectl to use the cluster..."
# k3d clusters are exposed as contexts named like: k3d-<cluster_name>
kubectl config use-context k3d-"$CLUSTER_NAME"

# -------------------------------------------------------------------
# 6. Ensure deploy keys exist, or run setup script
# -------------------------------------------------------------------

# Check if the expected private deploy key file exists
if [ ! -f "$KEY_DIR/study_app_gitops_deploy_key" ]; then
  echo -e "${YELLOW}Deploy keys not found.${NC}"
  # If a setup_deploy_key script exists and is executable, run it to generate keys
  if [ -x "$BASE_DIR/scripts/setup_deploy_key" ]; then
    echo "Running setup_deploy_key script..."
    "$BASE_DIR/scripts/setup_deploy_key"
  else
    # Otherwise, tell the user they must create the keys manually
    echo -e "${RED}Cannot find setup_deploy_key script. Please generate deploy keys manually.${NC}"
    exit 1
  fi
fi

# -------------------------------------------------------------------
# 7. Setup GitOps with Flux
# -------------------------------------------------------------------

echo "Setting up GitOps with Flux..."
# This separate script (next to this one) will run flux bootstrap/git setup etc.
"$SCRIPT_DIR/setup_gitops"
echo -e "${GREEN}GitOps setup completed!${NC}"

# -------------------------------------------------------------------
# 8. Wait for Flux controllers to be ready in the cluster
# -------------------------------------------------------------------

echo "Waiting for Flux controllers to be ready..."
# Wait for all pods in the flux-system namespace to have condition Ready, up to 120 seconds
kubectl -n flux-system wait --for=condition=Ready pods --all --timeout=120s

echo -e "${GREEN}GitOps deployment configured successfully!${NC}"
echo "Flux will now sync and deploy the application from your GitOps repository."
echo -e "${YELLOW}Note: Your GitOps repository should have proper Kubernetes manifests in the clusters/dev path.${NC}"

# -------------------------------------------------------------------
# 9. Helpful commands for the user
# -------------------------------------------------------------------

echo -e "\nTo check the status of Flux GitOps:"
echo -e "${YELLOW}flux get all${NC}"

echo -e "\nTo check deployment status:"
echo -e "${YELLOW}kubectl get pods -n study-app${NC}"

echo -e "\nTo delete the cluster when finished:"
echo -e "${YELLOW}k3d cluster delete $CLUSTER_NAME${NC}"
